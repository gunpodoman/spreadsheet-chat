<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>종합 웹 시스템</title>
    <style>
        body { font-family: sans-serif; background: #f4f7f6; display: flex; justify-content: center; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); width: 400px; }
        .hidden { display: none; }
        input { width: 100%; padding: 10px; margin: 5px 0; box-sizing: border-box; }
        button { width: 100%; padding: 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 5px 0; }
        button.secondary { background: #6c757d; }
        #chatBox { height: 300px; border: 1px solid #ddd; overflow-y: auto; padding: 10px; margin-bottom: 10px; background: #fafafa; }
        .msg-item { margin-bottom: 8px; font-size: 0.9em; }
        .msg-id { font-weight: bold; color: #007bff; }
        .nav { text-align: right; font-size: 0.8em; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="card">
        <div id="authView">
            <h2 id="authTitle">로그인</h2>
            <input type="text" id="id" placeholder="아이디">
            <input type="password" id="pw" placeholder="비밀번호">
            <button onclick="handleAuth()" id="mainBtn">로그인</button>
            <button onclick="toggleAuth()" class="secondary" id="subBtn">회원가입하러 가기</button>
        </div>

        <div id="mainView" class="hidden">
            <div class="nav">접속중: <span id="displayId"></span> | <a href="#" onclick="showSettings()">정보수정</a> | <a href="#" onclick="logout()">로그아웃</a></div>
            
            <div id="chatSection">
                <h3>공용 채팅방</h3>
                <div id="chatBox"></div>
                <input type="text" id="chatInput" placeholder="메시지를 입력하세요..." onkeypress="if(event.keyCode==13) sendChat()">
                <button onclick="sendChat()">전송</button>
            </div>

            <div id="settingsSection" class="hidden">
                <h3>내 정보 수정</h3>
                <input type="text" id="newId" placeholder="새 아이디">
                <input type="password" id="newPw" placeholder="새 비밀번호">
                <button onclick="updateProfile()">수정 완료</button>
                <button onclick="hideSettings()" class="secondary">취소</button>
            </div>
        </div>
    </div>

    <script>
        const GAS_URL = "여기에_복사한_웹_앱_URL_붙여넣기";
        let isSignup = false;
        let currentUser = localStorage.getItem("chat_user") || null;

        // 초기 화면 설정
        if(currentUser) showMain();

        function toggleAuth() {
            isSignup = !isSignup;
            document.getElementById("authTitle").innerText = isSignup ? "회원가입" : "로그인";
            document.getElementById("mainBtn").innerText = isSignup ? "가입하기" : "로그인";
            document.getElementById("subBtn").innerText = isSignup ? "로그인하러 가기" : "회원가입하러 가기";
        }

        async function api(data) {
            const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(data) });
            return await res.json();
        }

        async function handleAuth() {
            const id = document.getElementById("id").value;
            const pw = document.getElementById("pw").value;
            if(!id || !pw) return alert("입력해주세요.");

            const action = isSignup ? "signup" : "login";
            const data = await api({ action, id, pw });

            if(data.result === "success") {
                if(isSignup) { alert("가입 완료! 로그인해주세요."); toggleAuth(); }
                else { currentUser = id; localStorage.setItem("chat_user", id); showMain(); }
            } else {
                alert(data.result === "exists" ? "이미 존재하는 ID입니다." : "정보가 일치하지 않습니다.");
            }
        }

        function showMain() {
            document.getElementById("authView").classList.add("hidden");
            document.getElementById("mainView").classList.remove("hidden");
            document.getElementById("displayId").innerText = currentUser;
            loadChats();
            setInterval(loadChats, 3000); // 3초마다 채팅 갱신
        }

        async function sendChat() {
            const msg = document.getElementById("chatInput").value;
            if(!msg) return;
            await api({ action: "sendChat", id: currentUser, msg: msg });
            document.getElementById("chatInput").value = "";
            loadChats();
        }

        async function loadChats() {
            const data = await api({ action: "getChat" });
            const box = document.getElementById("chatBox");
            box.innerHTML = data.messages.map(m => `
                <div class="msg-item"><span class="msg-id">${m.id}:</span> ${m.msg}</div>
            `).join('');
            box.scrollTop = box.scrollHeight;
        }

        function showSettings() {
            document.getElementById("chatSection").classList.add("hidden");
            document.getElementById("settingsSection").classList.remove("hidden");
            document.getElementById("newId").value = currentUser;
        }

        function hideSettings() {
            document.getElementById("chatSection").classList.remove("hidden");
            document.getElementById("settingsSection").classList.add("hidden");
        }

        async function updateProfile() {
            const newId = document.getElementById("newId").value;
            const newPw = document.getElementById("newPw").value;
            const data = await api({ action: "update", oldId: currentUser, newId, newPw });
            if(data.result === "success") {
                alert("수정되었습니다. 다시 로그인해주세요.");
                logout();
            }
        }

        function logout() {
            localStorage.removeItem("chat_user");
            location.reload();
        }
    </script>
</body>
</html>
